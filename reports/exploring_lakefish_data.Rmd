---
title: "Exploring lakefish data"
author: "Emma Sofie Skarstein and Lyder Iversen"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include = FALSE}
library(ggplot2)
library(sf) # for sf objects
library(dplyr) # for smoother dataframe-manipulation
library(here) # for cleaner filepath-handling
library(mapview) # for nice maps
library(ggmap) # also for nice maps
library(maps)
library(maptools)
library(mapdata)
library(cowplot)
```

We will be looking at observations of freshwater fish in Norwegian lakes. Our observations are obtained from GBIF (more formal referencing of data somehow?), by first downloading all ray-finned fish (Actinopterygii) observations registered in Norway, and then filtering these based on the following steps:

1. Filter out species not in list of Norwegian freshwater fish, as described by SNL (see list below)
2. Match all species to closest lake, and remove observation further than 10 meters from the closest lake
3. Remove species with less than 1000 observations
4. Remove all observations with no time

```{r}
fish_names <- read.table(here::here("fish_names.txt", sep = "\n"), stringsAsFactors = FALSE)[,1]
cat(fish_names)
```

```{r}
occ_matched <- readRDS(here::here("data","occ_matched.rds"))
lakes <- readRDS(here::here("data","lake_polygons.rds"))
#(pÃ¥ emma sin pc:)
occ_matched <- readRDS(here::here("data", paste0("GBIF_download_all_fish_matched.rds")))
```

First, let us take a look at the number of observations of each species. 
```{r}
# Bar plot of different species
species_counts <- count(large_occ, vars = species)
ggplot(species_counts, aes(x = vars, y = n)) + 
  geom_bar(stat = "identity", color="black", fill="white") + 
  theme_light() + 
  theme(text = element_text(size = 10), 
        axis.text.x = element_text(angle = 45, hjust = 1))
```


```{r, wa}
# Faceted plots of all species data
ggplot(large_occ) +
  geom_map(data = norway, map = norway, aes(long, lat, map_id=region), 
           color="#2b2b2b", fill = "white") + 
  geom_point(aes(x = decimalLongitude, y = decimalLatitude), 
             show.legend = FALSE, alpha = 0.5, size = 1, color = "red3")  +
  facet_wrap(~ species, ncol = 4)
```

```{r}

data.coords <- cbind(occ_matched$decimalLongitude, occ_matched$decimalLatitude)
# data.coords <- SpatialPointsDataFrame(coords=cbind("long"=occ_matched$decimalLongitude, "lat"=occ_matched$decimalLatitude))

# Plot presence/absence
norway <- ggplot2::map_data("world", region = "Norway(?!:Svalbard)")
ggplot() + geom_map(data = norway, map = norway, aes(long, lat, map_id=region), color="#2b2b2b", fill=NA) + geom_point(aes(x = lakes$decimalLongitude, y = lakes$decimalLatitude), size=0.001, color = "grey") + geom_point(aes(x = occ_matched$decimalLongitude, y = occ_matched$decimalLatitude), size=0.001, color = "red")

```

```{r}
norway <- ggplot2::map_data("world", region = "Norway(?!:Svalbard)")

occ_nona <- occ_matched[complete.cases(occ_matched$year,occ_matched$month,occ_matched$day),]

pick <- function(condition){
  function(d) d %>% filter(!!enquo(condition))
}

norway1980 <- ggplot(data = occ_nona, aes(x = decimalLongitude, y = decimalLatitude)) +
  geom_map(data = norway, map = norway, aes(long, lat, map_id=region), color="#2b2b2b", fill="white") +
  geom_point(data = pick(year<1980 & year>1970), size=0.001, color = "red")

norway1990 <- ggplot(data = occ_nona, aes(x = decimalLongitude, y = decimalLatitude)) +
  geom_map(data = norway, map = norway, aes(long, lat, map_id=region), color="#2b2b2b", fill="white") +
  geom_point(data = pick(year<1990 & year>1980), size=0.001, color = "red")

norway2000 <- ggplot(data = occ_nona, aes(x = decimalLongitude, y = decimalLatitude)) +
  geom_map(data = norway, map = norway, aes(long, lat, map_id=region), color="#2b2b2b", fill="white") +
  geom_point(data = pick(year<2000 & year>1990), size=0.001, color = "red")

norway2010 <- ggplot(data = occ_nona, aes(x = decimalLongitude, y = decimalLatitude)) +
  geom_map(data = norway, map = norway, aes(long, lat, map_id=region), color="#2b2b2b", fill="white") +
  geom_point(data = pick(year<2010 & year>2000), size=0.001, color = "red")

plot_grid(norway1980, norway1990, norway2000, norway2010, labels = "AUTO")
```